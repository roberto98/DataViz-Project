<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>D3: Loading GeoJSON data and generating SVG paths</title>
		<script type="text/javascript" src="../d3.js"></script>
		<style type="text/css">
		</style>
	</head>
	<body>
<svg id="my_dataviz" width="400" height="300"></svg>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<script type="text/javascript">

	var svg = d3.select("svg"),
		width = +svg.attr("width"),
		height = +svg.attr("height");

	var projection = d3.geoLaskowski()
		.scale(70)
		.center([0,20])
		.translate([width / 2, height / 2]);

	var path = d3.geoPath().projection(projection);

	var formatDecimals = d3.format(".3")
	var color = d3.scaleQuantize()
		.range(["rgb(237,248,233)","rgb(186,228,179)","rgb(116,196,118)","rgb(49,163,84)","rgb(0,109,44)"]);
	
	d3.csv("kaggle_dataset.csv",function(data){

		const xItem = ["Adult Mortality", "infant deaths", "Alcohol", "percentage expenditure", "Hepatitis B", "Measles "," BMI ","under-five deaths ","Polio","Total expenditure","Diphtheria "," HIV/AIDS","GDP"," thinness  1-19 years"," thinness 5-9 years","Income composition of resources","Schooling"]
		const yItem = ["2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2010", "2011", "2012", "2013", "2014", "2015"]

		// add the options to the button
		d3.select("#selection-x")
		.selectAll('myOptions')
		.data(xItem)
		.enter()
		.append('option')
		.text(function (d) {
				return d;
		}) // text showed in the menu
		.attr("value", function (d) {
				return d;
		}) // corresponding value returned by the button

		d3.select("#selection-y")
		.selectAll('myOptions')
		.data(yItem)
		.enter()
		.append('option')
		.text(function (d) {
				return d;
		})
		.attr("value", function (d) {
				return d;
		})

		function display(xVal, yVal){
			var targetCol = xVal;
			var targetYear = yVal;
			
			var data = data.filter(function(d){return d.Year==targetYear})

			var allExpectancies = []
			var allValues = []
			d3.json("world.json", function(json){
				for (var i = 0; i < data.length; i++) {
					var dataCountry = data[i].Country;
					var dataValue = parseFloat(data[i][targetCol]);
					var dataLifeExp = parseFloat(data[i]["Life expectancy "]);
					for (var j = 0; j < json.features.length; j++) {
						var jsonCountry = json.features[j].properties.name;
						if (dataCountry == jsonCountry) {
							json.features[j].properties.value = dataValue;
							json.features[j].properties.lifeExp = dataLifeExp;
							allExpectancies.push(dataLifeExp);
							allValues.push(dataValue);
							break;
						}
					}
				}
				color.domain([d3.min(allValues), d3.max(allValues)]);

				// ---------- DISEGNA MAPPA ------- //
				svg.selectAll("path")
					.data(json.features)
					.enter()
					.append("path")
					.attr("d", path)
					.style("fill", function(d){
						var value = d.properties.value;
						if (value)
							return color(value);
						else
							return "#ccc";
					});
				svg.selectAll("text")
					.data(json.features)
					.enter()
					.append("text")
					.attr("font-family", "Arial")
					.attr("font-size", function(d){
						return 0.3 * Math.sqrt(path.area(d));
					})
					.attr("fill", "black")
					.attr("stroke", "white")
					.attr("stroke-width", function(d){
						var font_size = 0.3 * Math.sqrt(path.area(d));
						return font_size * 0.02;
					})
					.attr("x", function(d){
						return path.centroid(d)[0] - (0.3 * Math.sqrt(path.area(d)));
					})
					.attr("y", function(d){
						return path.centroid(d)[1] + (0.3 * Math.sqrt(path.area(d))/2);
					})
					.text(function(d){
						if (d.properties.lifeExp){
							return formatDecimals(d.properties.lifeExp);
						}
					})

			})
		}

	display(" BMI ", "2005")

	// When the button is changed, run the updateChart function
	d3.select("#selection-x").on("change", function(event,d) {
		// recover the option that has been chosen
		const selectedOptionX = d3.select(this).property("value")
		// run the updateChart function with this selected option
		display(selectedOptionX, d3.select("#selection-y").property("value"))
	})

	// When the button is changed, run the updateChart function
	d3.select("#selection-y").on("change", function(event,d) {
		// recover the option that has been chosen
		const selectedOptionY = d3.select(this).property("value")
		// run the updateChart function with this selected option
		display(d3.select("#selection-x").property("value"), selectedOptionY)
	})

	})

</script>
</body>
</html>